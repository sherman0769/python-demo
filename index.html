<!DOCTYPE html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>éŠ€æ²³é¾èˆ‡åœ°åŸ â€§ AI RPG</title>
<style>
body{font-family:system-ui;padding:0 1rem;max-width:680px;margin:auto}
h1{display:flex;align-items:center;gap:.4rem}
#log{white-space:pre-wrap;background:#f7f7f7;padding:1rem;
     border-radius:8px;height:55vh;overflow:auto}
#scene{max-width:100%;border-radius:8px;margin-top:1rem;display:none}
#msg{width:100%;padding:.6rem;border-radius:6px;border:1px solid #ccc;margin-top:.8rem}
button{margin-top:.5rem;padding:.5rem 1.2rem;border:0;border-radius:6px;background:#0070f3;color:#fff}
</style>
<h1>ğŸ¥ éŠ€æ²³é¾èˆ‡åœ°åŸ â€¢ æ–‡å­—å†’éšª</h1>

<div id="log">(æ•…äº‹é–‹å§‹ï¼è«‹è¼¸å…¥ä½ çš„å‹•ä½œâ€¦)</div>
<img id="scene">

<input id="msg" placeholder="è¼¸å…¥å‹•ä½œï¼ä¾‹å¦‚ï¼šã€æˆ‘èˆ‰åŠè¡å‘æ©Ÿæ¢°å·¨é¾ã€"/>
<button id="send">é€å‡º</button>

<script>
const log   = document.getElementById('log');
const img   = document.getElementById('scene');
const msgIn = document.getElementById('msg');
const histKey="rpg_history";
let history = JSON.parse(localStorage.getItem(histKey)||"[]");

// è¼‰å…¥èˆŠåŠ‡æƒ…
history.forEach(h=>{
  log.textContent += `\n\nã€ä½ ã€‘\n${h.user}\n\nã€GMã€‘\n${h.gm}`;
});

function add(text, who){
  log.textContent += `\n\nã€${who}ã€‘\n`+ text;
  log.scrollTop = log.scrollHeight;
}

async function send(){
  if(send.cooldown) return;          // 5 ç§’å†·å»é¿å…çˆ†é‡ç”¢åœ–
  send.cooldown = true; setTimeout(()=>send.cooldown=false,5000);

  const user = msgIn.value.trim();
  if(!user) return;
  add(user,"ä½ ");
  msgIn.value = "";

  const res = await fetch("/api/rpg",{
    method:"POST",
    body: JSON.stringify({user, history})
  });
  const data = await res.json();
  if(data.error){ add("âš ï¸ "+data.error,"ç³»çµ±"); return;}

  add(data.reply,"GM");
  if(data.image){
    img.src="data:image/png;base64,"+data.image;
    img.style.display="block";
  }
  history = data.history;
  localStorage.setItem(histKey, JSON.stringify(history));
}

document.getElementById('send').onclick = send;
msgIn.addEventListener("keydown", e=>{ if(e.key==="Enter") send();});
</script>
</html>
