<!DOCTYPE html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI RPG</title>
<!-- åœ–ç‰‡ç”ŸæˆåŠŸèƒ½å·²ç§»é™¤ï¼Œé¿å…é¡¯ç¤ºã€Œã€ç³»çµ±ã€‘æ’åœ–ç”Ÿæˆå¤±æ•—ã€è¨Šæ¯ -->
<style>
body{font-family:system-ui;padding:0 1rem;max-width:680px;margin:auto}
h1{display:flex;align-items:center;gap:.4rem}
#log{white-space:pre-wrap;background:#f7f7f7;padding:1rem;
     border-radius:8px;height:55vh;overflow:auto}
#options{margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap}
#scenario{margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap}
#msg{width:100%;padding:.6rem;border-radius:6px;border:1px solid #ccc;margin-top:.8rem}
button{margin-top:.5rem;padding:.5rem 1.2rem;border:0;border-radius:6px;background:#0070f3;color:#fff}
</style>
<h1 id="title">ğŸ¥ AI RPG</h1>

<div id="log">(æ•…äº‹é–‹å§‹ï¼è«‹è¼¸å…¥ä½ çš„å‹•ä½œâ€¦)</div>
<div id="scenario"></div>
<div id="options"></div>

<input id="msg" placeholder="è¼¸å…¥å‹•ä½œï¼ä¾‹å¦‚ï¼šã€æˆ‘èˆ‰åŠè¡å‘æ©Ÿæ¢°å·¨é¾ã€"/>
<button id="send">é€å‡º</button>
<button id="newgame">æ–°æ•…äº‹</button>
<p style="text-align:center;margin-top:1rem">éŠæˆ²è¨­è¨ˆï¼šæè©©æ°‘</p>

<script>
const titleEl = document.getElementById('title');
const log   = document.getElementById('log');
const msgIn = document.getElementById('msg');
const opts  = document.getElementById('options');
const scn   = document.getElementById('scenario');
const newBtn = document.getElementById('newgame');
const histKey="rpg_history";
const scnKey="rpg_scn";
let history = JSON.parse(localStorage.getItem(histKey)||"[]");
let scenario = localStorage.getItem(scnKey);

const scenarios = {
  jy:{
    label:"é‡‘åº¸ç¾¤ä¿ ç©¿è¶Šå‚³",
    background:"ä½ ç©¿è¶Šåˆ°é‡‘åº¸æ­¦ä¿ ä¸–ç•Œï¼Œèˆ‡å„è·¯ä¿ å®¢ç›¸é‡ã€‚"
  },
  sg:{
    label:"ä¸‰åœ‹ç¾¤é›„ç©¿è¶Šå‚³",
    background:"ä½ ä¾†åˆ°çƒ½ç«é€£å¤©çš„ä¸‰åœ‹æ™‚ä»£ï¼Œè±ªå‚‘ä¸¦èµ·ã€‚"
  }
};

function showScenarioSelect(){
  log.textContent = 'è«‹é¸æ“‡æ•…äº‹ï¼š';
  scn.innerHTML = '';
  for(const [key,sc] of Object.entries(scenarios)){
    const btn = document.createElement('button');
    btn.textContent = sc.label;
    btn.onclick = ()=>{
      scenario = key;
      localStorage.setItem(scnKey,scenario);
      titleEl.textContent = `ğŸ¥ ${sc.label} â€¢ æ–‡å­—å†’éšª`;
      log.textContent = sc.background + '\n\n(æ•…äº‹é–‹å§‹ï¼è«‹è¼¸å…¥ä½ çš„å‹•ä½œâ€¦)';
      scn.innerHTML = '';
      opts.innerHTML = '';
    };
    scn.appendChild(btn);
  }
}

// è¼‰å…¥èˆŠåŠ‡æƒ…
if(history.length){
  const sc = scenarios[scenario];
  if(sc) titleEl.textContent = `ğŸ¥ ${sc.label} â€¢ æ–‡å­—å†’éšª`;
  history.forEach(h=>{
    log.textContent += `\n\nã€ä½ ã€‘\n${h.user}\n\nã€GMã€‘\n${h.gm}`;
  });
}else{
  showScenarioSelect();
}

function add(text, who){
  log.textContent += `\n\nã€${who}ã€‘\n`+ text;
  log.scrollTop = log.scrollHeight;
}

function showOptions(text){
  opts.innerHTML = '';
  text.split(/\n+/).forEach(line=>{
    const m = line.trim().match(/^([ABC])[\.\)\s\u3001\uFF0E\uFF61]?\s*(.+)/);
    if(m){
      const btn = document.createElement('button');
      btn.textContent = line.trim();
      btn.onclick = ()=>{ msgIn.value = m[1]; send(); };
      opts.appendChild(btn);
    }
  });
}

function stripOptions(text){
  return text.split(/\n+/)
    .filter(line => !line.trim().match(/^([ABC])[\.\)\s\u3001\uFF0E\uFF61]?\s*(.+)/))
    .join('\n');
}

function newGame(){
  history = [];
  scenario = null;
  localStorage.removeItem(histKey);
  localStorage.removeItem(scnKey);
  opts.innerHTML = '';
  msgIn.value = '';
  showScenarioSelect();
}

async function send(){
  if(send.cooldown) return;          // 5 ç§’å†·å»é¿å…ä¼ºæœå™¨éè¼‰
  send.cooldown = true; setTimeout(()=>send.cooldown=false,5000);

  opts.innerHTML = '';

  const user = msgIn.value.trim();
  if(!user) return;
  add(user,"ä½ ");
  msgIn.value = "";

  const res = await fetch("/api/rpg",{
    method:"POST",
    body: JSON.stringify({user, history, scenario})
  });
  const data = await res.json();
  if(data.error){ add("âš ï¸ "+data.error,"ç³»çµ±"); return;}

  showOptions(data.reply);
  add(stripOptions(data.reply),"GM");
  history = data.history;
  localStorage.setItem(histKey, JSON.stringify(history));
}

document.getElementById('send').onclick = send;
newBtn.onclick = newGame;
msgIn.addEventListener("keydown", e=>{ if(e.key==="Enter") send();});
</script>
</html>
